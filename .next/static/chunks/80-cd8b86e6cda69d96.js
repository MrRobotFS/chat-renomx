"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[80],{6281:function(e,t,o){o.d(t,{AuthProvider:function(){return i},a:function(){return l}});var n=o(7437),r=o(2265),s=o(4502);let a=(0,r.createContext)(void 0);function i(e){let{children:t}=e,[o,i]=(0,r.useState)(null),[l,c]=(0,r.useState)(!0),u=async()=>{let e=localStorage.getItem("authToken"),t=localStorage.getItem("currentUser");if(!e||!t)return c(!1),!1;try{let o=JSON.parse(t);try{let e=await s.x.getProfile();i(e),localStorage.setItem("currentUser",JSON.stringify(e))}catch(t){i(o),s.x.setToken(e)}return c(!1),!0}catch(e){return console.error("Auth check failed:",e),localStorage.removeItem("authToken"),localStorage.removeItem("currentUser"),s.x.clearToken(),i(null),c(!1),!1}};return(0,r.useEffect)(()=>{u()},[]),(0,n.jsx)(a.Provider,{value:{user:o,isLoading:l,isAuthenticated:!!o,login:(e,t)=>{localStorage.setItem("authToken",t),localStorage.setItem("currentUser",JSON.stringify(e)),s.x.setToken(t),i(e)},logout:()=>{localStorage.removeItem("authToken"),localStorage.removeItem("currentUser"),Object.keys(localStorage).forEach(e=>{e.startsWith("conversations_")&&localStorage.removeItem(e)}),s.x.clearToken(),i(null)},checkAuth:u},children:t})}function l(){let e=(0,r.useContext)(a);if(void 0===e)throw Error("useAuth must be used within an AuthProvider");return e}},3080:function(e,t,o){o.d(t,{R:function(){return a}});var n=o(2265),r=o(4502),s=o(6281);function a(){let{user:e,isAuthenticated:t}=(0,s.a)(),[o,a]=(0,n.useState)({conversations:[],currentConversationId:null,isLoading:!1});(0,n.useEffect)(()=>{t&&e?i():a(e=>({...e,conversations:[],currentConversationId:null}))},[t,e]),(0,n.useEffect)(()=>{if(t&&e){let t="conversations_".concat(e.employee.id),n="session_conversations_".concat(e.employee.id);if(o.conversations.length>0)try{let e=o.conversations.filter(e=>e.messages&&e.messages.length>0);if(e.length>0){let o=JSON.stringify(e);localStorage.setItem(t,o),sessionStorage.setItem(n,o)}}catch(e){console.error("Failed to save conversations:",e)}}else t||(Object.keys(localStorage).forEach(e=>{(e.startsWith("conversations_")||e.startsWith("session_conversations_"))&&localStorage.removeItem(e)}),Object.keys(sessionStorage).forEach(e=>{(e.startsWith("conversations_")||e.startsWith("session_conversations_"))&&sessionStorage.removeItem(e)}))},[o.conversations,t,e]);let i=(0,n.useCallback)(async()=>{if(t&&e)try{let t="conversations_".concat(e.employee.id),o="session_conversations_".concat(e.employee.id),n=null;if(n=localStorage.getItem(t)||sessionStorage.getItem(o))try{let e=JSON.parse(n);if(Array.isArray(e)){a(t=>{let o=e.map(e=>e.id),n=[...e,...t.conversations.filter(e=>!o.includes(e.id)&&(!e.messages||0===e.messages.length))];return{...t,conversations:n}}),localStorage.setItem(t,JSON.stringify(e)),sessionStorage.setItem(o,JSON.stringify(e));return}}catch(e){console.error("Failed to parse stored conversations:",e)}try{let e=await r.x.getConversations();a(t=>({...t,conversations:e})),localStorage.setItem(t,JSON.stringify(e)),sessionStorage.setItem(o,JSON.stringify(e))}catch(e){a(e=>({...e,conversations:[]}))}}catch(e){console.error("Failed to load conversations:",e),a(e=>({...e,conversations:[]}))}},[t,e]),l=(0,n.useCallback)(async o=>{if(!t||!e)return null;try{let t={id:crypto.randomUUID(),employee:e.employee,title:o||"Nueva conversaci\xf3n",created_at:new Date().toISOString(),updated_at:new Date().toISOString(),is_active:!0,messages:[]};return a(e=>({...e,conversations:[t,...e.conversations],currentConversationId:t.id})),t}catch(e){return console.error("Failed to create conversation:",e),null}},[t,e]),c=(0,n.useCallback)(async t=>{a(o=>{if(!o.conversations.some(e=>e.id===t)&&e){let n="conversations_".concat(e.employee.id),r=localStorage.getItem(n);if(r)try{let e=JSON.parse(r).find(e=>e.id===t);if(e)return{...o,conversations:[e,...o.conversations],currentConversationId:t}}catch(e){console.error("Error parsing stored conversations:",e)}}return{...o,currentConversationId:t}})},[e]),u=(0,n.useCallback)(async e=>{if(t)try{a(t=>({...t,conversations:t.conversations.filter(t=>t.id!==e),currentConversationId:t.currentConversationId===e?null:t.currentConversationId}))}catch(e){console.error("Failed to delete conversation:",e)}},[t]),d=(0,n.useCallback)(async(n,s)=>{if(!e||!t)return;a(e=>({...e,isLoading:!0}));let i={id:Date.now()+Math.random(),content:n,is_user:!0,timestamp:new Date().toISOString(),has_file:!!s,file:s},l=o.currentConversationId||crypto.randomUUID();a(t=>{if(t.conversations.find(e=>e.id===l)){let e=t.conversations.map(e=>e.id===l?{...e,messages:[...e.messages||[],i],updated_at:new Date().toISOString()}:e);return{...t,conversations:e,currentConversationId:l}}{let o={id:l,employee:e.employee,title:n.length>50?n.substring(0,50)+"...":n,created_at:new Date().toISOString(),updated_at:new Date().toISOString(),is_active:!0,messages:[i]};return{...t,conversations:[o,...t.conversations],currentConversationId:l}}});try{let t=await r.x.sendMessage({message:n,conversation_id:l,file:s,has_file:!!s},e),o={id:Date.now()+Math.random()+1e3,content:t.ai_response.content,is_user:!1,timestamp:new Date().toISOString(),has_file:!1};a(e=>{let t=e.conversations.map(e=>e.id===l?{...e,messages:[...e.messages||[],o],updated_at:new Date().toISOString()}:e);return{...e,conversations:t,isLoading:!1}})}catch(e){console.error("Error sending message:",e),a(e=>({...e,isLoading:!1}))}},[o.currentConversationId,e,t]),v=(0,n.useCallback)(()=>o.currentConversationId&&o.conversations.find(e=>e.id===o.currentConversationId)||null,[o.conversations,o.currentConversationId]),m=(0,n.useCallback)(async e=>{if(!o.currentConversationId)return null;try{let t=await r.x.uploadFile(o.currentConversationId,e);return await i(),t}catch(e){return console.error("Failed to upload file:",e),null}},[o.currentConversationId,i]);return{conversations:o.conversations,currentConversation:v(),isLoading:o.isLoading,user:e,createConversation:l,selectConversation:c,deleteConversation:u,sendMessage:d,uploadFile:m,loadConversations:i,debugState:()=>{}}}},4502:function(e,t,o){o.d(t,{x:function(){return s}});let n="".concat("https://renovablesdelsurmx.online:8443","/api/chatbot");class r{setToken(e){this.token=e,localStorage.setItem("authToken",e)}clearToken(){this.token=null,localStorage.removeItem("authToken")}getToken(){return this.token}getBaseUrl(){return n}async request(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},o="".concat(n).concat(e),r={"Content-Type":"application/json",...t.headers};this.token&&(r.Authorization="Bearer ".concat(this.token));try{let e=await fetch(o,{...t,headers:r});if(!e.ok){if(401===e.status)throw this.clearToken(),Error("Authentication failed");throw Error("HTTP error! status: ".concat(e.status))}return await e.json()}catch(e){throw console.error("API request failed:",e),e}}async login(e){let t=await this.request("/employee/login/",{method:"POST",body:JSON.stringify(e)});return t.success&&this.setToken(t.access),t}async getProfile(){return await this.request("/employee/profile/")}async getConversations(){return await this.request("/employee/conversations/")}async getConversation(e){return await this.request("/employee/conversations/".concat(e,"/"))}async sendMessage(e,t){var o,n,r,s,a,i;let l={message:e.message,conversation_id:e.conversation_id,has_file:e.has_file||!1,file:e.file?{name:e.file.name,size:e.file.size,type:e.file.type,extension:e.file.extension,data:e.file.data}:null,user:t?{email:t.email,username:t.username,full_name:null===(o=t.employee)||void 0===o?void 0:o.full_name,department:null===(n=t.employee)||void 0===n?void 0:n.department,role:null===(r=t.employee)||void 0===r?void 0:r.role_name,role_code:null===(s=t.employee)||void 0===s?void 0:s.role_code,employee_id:null===(a=t.employee)||void 0===a?void 0:a.employee_id}:null};try{let t=Date.now(),o=await fetch("https://n8n.srv865372.hstgr.cloud/webhook/615091e3-d7c3-477d-9d64-fae01c60845b",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(l)});if(!o.ok)throw Error("HTTP error! status: ".concat(o.status));let n=await o.json(),r=Date.now(),s=(null===(i=n[0])||void 0===i?void 0:i.output)||"Lo siento, no pude obtener una respuesta.",a=e.conversation_id||crypto.randomUUID(),c={id:Date.now(),content:e.message,is_user:!0,timestamp:new Date().toISOString(),has_file:e.has_file||!1,file:e.file},u={id:Date.now()+1,content:s,is_user:!1,timestamp:new Date().toISOString(),response_time:r-t,has_file:!1};return{conversation_id:a,user_message:c,ai_response:u,source:"n8n_webhook"}}catch(e){throw console.error("API request failed:",e),e}}async uploadFile(e,t){let o=new FormData;o.append("file",t),o.append("file_name",t.name),o.append("file_type",t.type.startsWith("image/")?"image":"document");let r={};this.token&&(r.Authorization="Bearer ".concat(this.token));try{let t=await fetch("".concat(n,"/employee/conversations/").concat(e,"/upload/"),{method:"POST",headers:r,body:o});if(!t.ok)throw Error("HTTP error! status: ".concat(t.status));return await t.json()}catch(e){throw console.error("File upload failed:",e),e}}logout(){this.clearToken()}constructor(){this.token=null,this.token=localStorage.getItem("authToken")}}let s=new r}}]);